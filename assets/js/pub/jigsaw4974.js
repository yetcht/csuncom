"use strict";var _createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e){var s=42,r=Math.PI,o=63;function n(e,t){return Math.round(Math.random()*(t-e)+e)}function t(e){var t=c("img");return t.crossOrigin="Anonymous",t.onload=e,t.onerror=function(){},t.src="/r01/picsum_eimg/"+n(1,20)+".png",t}function c(e,t){e=document.createElement(e);return e.className=t,e}function l(e,t){e.classList.add(t)}function i(e,t,n,i){e.beginPath(),e.moveTo(t,n),e.arc(t+21,n-9+2,9,.72*r,2.26*r),e.lineTo(t+s,n),e.arc(t+s+9-2,n+21,9,1.21*r,2.78*r),e.lineTo(t+s,n+s),e.lineTo(t,n+s),e.arc(t+9-2,n+21,9.4,2.76*r,1.24*r,!0),e.lineTo(t,n),e.lineWidth=2,e.fillStyle="rgba(255, 255, 255, 1)",e.strokeStyle="rgba(255, 255, 255, 1)",e.stroke(),e[i](),e.globalCompositeOperation="overlay"}function a(e,t){return e+t}function u(e){return e*e}"classList"in document.documentElement||Object.defineProperty(HTMLElement.prototype,"classList",{get:function(){var s=this;function e(i){return function(e){var t=s.className.split(/\s+/g),n=t.indexOf(e);i(t,n,e),s.className=t.join(" ")}}return{add:e(function(e,t,n){~t||e.push(n)}),remove:e(function(e,t){~t&&e.splice(t,1)}),toggle:e(function(e,t,n){~t?e.splice(t,1):e.push(n)}),contains:function(e){return!!~s.className.split(/\s+/g).indexOf(e)},item:function(e){return s.className.split(/\s+/g)[e]||null}}}});_createClass(d,[{key:"init",value:function(){this.initDOM(),this.initImg(),this.bindEvents()}},{key:"initDOM",value:function(){e=this.w,t=this.h,(n=c("canvas")).width=e,n.height=t;var e=n,t=e.cloneNode(!0),n=c("div","sliderContainer"),i=c("div","refreshIcon"),s=c("div","sliderMask"),r=c("div","slider"),o=c("span","sliderIcon"),a=c("span","sliderText"),l=(t.className="block",a.innerHTML=this.title,this.el);l.appendChild(e),l.appendChild(i),l.appendChild(t),r.appendChild(o),s.appendChild(r),n.appendChild(s),n.appendChild(a),l.appendChild(n),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),i=1;i<arguments.length;i++){var s=arguments[i];if(null!=s)for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(n[r]=s[r])}return n},writable:!0,configurable:!0}),Object.assign(this,{canvas:e,block:t,sliderContainer:n,refreshIcon:i,slider:r,sliderMask:s,sliderIcon:o,text:a,canvasCtx:e.getContext("2d"),blockCtx:t.getContext("2d")}),$(e).css("top","-"+this.h+"px"),$(t).css("top","-"+this.h+"px")}},{key:"initImg",value:function(){var n=this,i=t(function(){n.canvasCtx.drawImage(i,0,0,n.w,n.h),n.draw(),n.blockCtx.drawImage(i,0,0,n.w,n.h);var e,t=n.y-18-1;-1<navigator.userAgent.indexOf("MSIE")?n.block.style.marginLeft="-"+(n.x-3)+"px":(e=n.blockCtx.getImageData(n.x-3,t,o,o),n.block.width=o,n.blockCtx.putImageData(e,0,t))});this.img=i}},{key:"draw",value:function(){this.x=n(73,this.w-73),this.y=n(28,this.h-73),i(this.canvasCtx,this.x,this.y,"fill"),i(this.blockCtx,this.x,this.y,"clip")}},{key:"clean",value:function(){this.canvasCtx.clearRect(0,0,this.w,this.h),this.blockCtx.clearRect(0,0,this.w,this.h),this.block.width=this.w}},{key:"bindEvents",value:function(){function e(e){s=e.clientX||e.touches[0].clientX,r=e.clientY||e.touches[0].clientY,a=!0,this.isShow||$(".img-sliderval canvas").show()}function t(e){if(!a)return!1;var t=e.clientX||e.touches[0].clientX,e=(e=e.clientY||e.touches[0].clientY)-r;if((t=t-s)<0||38+t>=i.w)return!1;i.slider.style.left=t+"px";var n=(i.w-40-20)/(i.w-40)*t;i.block.style.left=n+"px",l(i.sliderContainer,"sliderContainer_active"),i.sliderMask.style.width=t+"px",o.push(e)}function n(e){if(!a)return!1;if(a=!1,this.isShow||$(".img-sliderval canvas").hide(),(e.clientX||e.changedTouches[0].clientX)==s)return!1;e=i.sliderContainer,t="sliderContainer_active",e.classList.remove(t),i.trail=o;var t=(e=i.verify()).spliced,e=e.verified;t?e?(l(i.sliderContainer,"sliderContainer_success"),"function"==typeof i.onSuccess&&i.onSuccess()):(l(i.sliderContainer,"sliderContainer_fail"),i.text.innerHTML="再试一次",i.reset()):(l(i.sliderContainer,"sliderContainer_fail"),"function"==typeof i.onFail&&i.onFail(),setTimeout(function(){i.reset()},1e3))}var i=this,s=(this.el.onselectstart=function(){return!1},this.refreshIcon.onclick=function(){i.reset(),"function"==typeof i.onRefresh&&i.onRefresh()},void 0),r=void 0,o=[],a=!1;this.slider.addEventListener("mousedown",e),this.slider.addEventListener("touchstart",e),document.addEventListener("mousemove",t),document.addEventListener("touchmove",t),document.addEventListener("mouseup",n),document.addEventListener("touchend",n)}},{key:"verify",value:function(){var e=this.trail,t=e.reduce(a)/e.length,n=e.map(function(e){return e-t}),n=Math.sqrt(n.map(u).reduce(a)/e.length),e=parseInt(this.block.style.left);return{spliced:Math.abs(e-this.x)<10,verified:0!==n}}},{key:"reset",value:function(){this.el.innerHTML="",this.init()}}]);var h=d;function d(e){var t=e.el,n=e.onSuccess,i=e.onFail,s=e.onRefresh;_classCallCheck(this,d),this.el=t,this.onSuccess=n,this.onFail=i,this.onRefresh=s,this.w=e.width,this.h=e.width/2,this.isShow=e.isShow,isNull(e.title)?this.title="向右滑动拼图":this.title=e.title}e.jigsaw={init:function(e){return new h(e).init()}}}(window);